<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Malla Interactiva AP UChile</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #f7f9ff, #e5ecff);
      color: #333;
    }

    header {
      text-align: center;
      padding: 2rem 1rem 1rem;
      background-color: #6a5acd;
      color: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .auth-container {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin: 2rem;
      flex-wrap: wrap;
    }

    .auth-box {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      width: 280px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }

    .auth-box input {
      width: 100%;
      padding: 0.7rem;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    .auth-box button {
      width: 100%;
      padding: 0.7rem;
      background: #6a5acd;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }

    #malla {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      padding: 2rem;
    }

    .ramo {
      width: 180px;
      padding: 1rem;
      background: #fff;
      border: 2px solid #ddd;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .ramo:hover {
      transform: scale(1.05);
    }

    .ramo.approved {
      background: #e6f6e6;
      border-color: #4caf50;
    }

    .ramo.locked {
      opacity: 0.5;
      pointer-events: none;
    }

    #loadingMessage {
      position: fixed;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: #6a5acd;
      color: white;
      padding: 0.8rem 1.5rem;
      border-radius: 10px;
      display: none;
    }
  </style>
</head>
<body>

<header>
  <h1>Malla Interactiva Administración Pública</h1>
  <p>Marca los ramos aprobados y guarda tu progreso</p>
</header>

<div id="loadingMessage">Cargando...</div>

<section class="auth-container">
  <div class="auth-box">
    <h3>Crear cuenta</h3>
    <input type="email" id="reg-email" placeholder="Correo electrónico" />
    <input type="password" id="reg-password" placeholder="Contraseña" />
    <button id="registerBtn">Registrarse</button>
  </div>

  <div class="auth-box">
    <h3>Iniciar sesión</h3>
    <input type="email" id="login-email" placeholder="Correo electrónico" />
    <input type="password" id="login-password" placeholder="Contraseña" />
    <button id="loginBtn">Entrar</button>
  </div>
</section>

<main id="malla"></main>

<!-- Firebase y lógica -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC0y-ES5y6c8uiYMKew-TEv-wz_iMbXaJc",
    authDomain: "malla-interactiva.firebaseapp.com",
    projectId: "malla-interactiva",
    storageBucket: "malla-interactiva.appspot.com", // CORREGIDO
    messagingSenderId: "1084098910135",
    appId: "1:1084098910135:web:62633e770f70cf534bba32",
    measurementId: "G-SG22ZFKRMD"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const ramos = [

{ id: "mat1", nombre: "🎓 Matemática para la Gestión I", color: "#ffe0eb", prereq: [] },
    { id: "intro", nombre: "🎓 Introducción a la Gestión Pública", color: "#ffe0eb", prereq: [] },
    { id: "histinst", nombre: "🎓 Historia de las Instituciones Políticas de Chile", color: "#ffe0eb", prereq: [] },
    { id: "sistemasinfo", nombre: "🎓 Tecnologías y Sistemas de Información", color: "#ffe0eb", prereq: [] },
    { id: "basesjur", nombre: "🎓 Bases Jurídicas para la Administración del Estado", color: "#ffe0eb", prereq: [] },
    { id: "ingles1", nombre: "🎓 Inglés I", color: "#ffe0eb", prereq: [] },
    { id: "curso1", nombre: "🎓 Curso Libre I", color: "#ffe0eb", prereq: [] },
    { id: "mat2", nombre: "📘 Matemática para la Gestión II", color: "#fce1ff", prereq: ["mat1"] },
    { id: "evo", nombre: "📘 Evolución y Complejidad de la Administración Pública", color: "#fce1ff", prereq: ["intro"] },
    { id: "ideas", nombre: "📘 Ideas y Debates Políticos Contemporáneos", color: "#fce1ff", prereq: [] },
    { id: "epistem", nombre: "📘 Epistemología de las Ciencias Sociales", color: "#fce1ff", prereq: [] },
    { id: "marconorm1", nombre: "📘 Marco Normativo I", color: "#fce1ff", prereq: ["basesjur"] },
    { id: "ingles2", nombre: "📘 Inglés II", color: "#fce1ff", prereq: ["ingles1"] },
    { id: "curso2", nombre: "📘 Curso Libre II", color: "#fce1ff", prereq: ["curso1"] },
    { id: "estad1", nombre: "📊 Estadística para la Gestión I", color: "#d1f5f0", prereq: ["mat2"] },
    { id: "admin", nombre: "📊 Comportamiento Humano en la Organización", color: "#d1f5f0", prereq: ["evo"] },
    { id: "fenomenos", nombre: "📊 Fenómenos Políticos", color: "#d1f5f0", prereq: ["
    { id: "micro", nombre: "📊 Microeconomía para la Gestión Pública", color: "#d1f5f0", prereq: ["mat2"] },
    { id: "marconorm2", nombre: "📊 Marco Normativo II", color: "#d1f5f0", prereq: ["marconorm1"] },
    { id: "metodocuali", nombre: "📊 Métodos Cualitativos", color: "#d1f5f0", prereq: ["epistem"] },
    { id: "polintl", nombre: "🌍 Política Internacional", color: "#fef5d6", prereq: ["fenomenos"] },
    { id: "diseñoorg", nombre: "🌍 Diseño Organizacional", color: "#fef5d6", prereq: ["admin"] },
    { id: "metodocuanti", nombre: "🌍 Métodos Cuantitativos", color: "#fef5d6", prereq: ["estad1"] },
    { id: "planeamiento", nombre: "🌍 Planeamiento Estratégico", color: "#fef5d6", prereq: ["diseñoorg"] },
    { id: "gestionfin", nombre: "🌍 Gestión Financiera Pública", color: "#fef5d6", prereq: ["micro"] },
    { id: "negociacion", nombre: "🧠 Negociación y Resolución de Conflictos", color: "#e3f0ff", prereq: ["admin"] },
    { id: "polpublica", nombre: "🧠 Ciclo y Evaluación de Políticas Públicas", color: "#e3f0ff", prereq: ["planeamiento"] },
    { id: "contabilidad", nombre: "🧠 Contabilidad Gubernamental", color: "#e3f0ff", prereq: ["gestionfin"] },
    { id: "gestionpersonas", nombre: "🧠 Gestión de Personas", color: "#e3f0ff", prereq: ["diseñoorg"] },
    { id: "gestionproy", nombre: "🧠 Gestión de Proyectos", color: "#e3f0ff", prereq: ["planeamiento"] },
    { id: "electivo1", nombre: "📈 Electivo I", color: "#fdebd0", prereq: [] },
    { id: "analisisempirico", nombre: "📈 Análisis Empírico de Políticas", color: "#fdebd0", prereq: ["metodocuanti", "metodocuali"] },
    { id: "electivo2", nombre: "📈 Electivo II", color: "#fdebd0", prereq: ["electivo1"] },
    { id: "electivo3", nombre: "📈 Electivo III", color: "#fdebd0", prereq: ["electivo2"] },
    { id: "cfg", nombre: "📈 Curso de Formación General", color: "#fdebd0", prereq: [] },
    { id: "asesoria", nombre: "💼 Simulación de Asesoría Política", color: "#dcd6f7", prereq: ["gestionproy"] },
    { id: "practica", nombre: "🎓 Práctica Profesional", color: "#fff0f0", prereq: ["polpublica"] },
    { id: "examen", nombre: "🎓 Examen de Título", color: "#fff0f0", prereq: ["analisisempirico"] },
  ];

    // Agrega el resto de los ramos igual como los tienes
  ];

  function crearMalla() {
    const cont = document.getElementById("malla");
    cont.innerHTML = "";
    ramos.forEach(r => {
      const div = document.createElement("div");
      div.id = r.id;
      div.className = "ramo locked";
      div.style.backgroundColor = r.color;
      div.innerHTML = `<strong>${r.nombre}</strong>`;
      div.addEventListener("click", () => {
        div.classList.toggle("approved");
        actualizarMalla();
        if (userId) guardarEstado(userId);
      });
      cont.appendChild(div);
    });
    actualizarMalla();
  }

  function actualizarMalla() {
    ramos.forEach(r => {
      const div = document.getElementById(r.id);
      const aprobado = div.classList.contains("approved");
      if (aprobado) {
        div.classList.remove("locked");
      } else {
        const ok = r.prereq.every(p => {
          const prDiv = document.getElementById(p);
          return prDiv && prDiv.classList.contains("approved");
        });
        div.classList.toggle("locked", !ok);
      }
    });
  }

  async function guardarEstado(uid) {
    const estado = {};
    ramos.forEach(r => {
      const div = document.getElementById(r.id);
      estado[r.id] = div.classList.contains("approved");
    });
    await setDoc(doc(db, "usuarios", uid), { estado });
  }

  async function cargarEstado(uid) {
    const docRef = doc(db, "usuarios", uid);
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
      const datos = docSnap.data().estado;
      for (let [id, aprobado] of Object.entries(datos)) {
        const div = document.getElementById(id);
        if (div) {
          div.classList.toggle("approved", aprobado);
        }
      }
      actualizarMalla();
    }
  }

  let userId = null;

  function mostrarCarga(msg) {
    const el = document.getElementById("loadingMessage");
    el.textContent = msg;
    el.style.display = "block";
  }

  function ocultarCarga() {
    document.getElementById("loadingMessage").style.display = "none";
  }

  // Eventos
  document.getElementById("registerBtn").addEventListener("click", () => {
    const email = document.getElementById("reg-email").value.trim();
    const pass = document.getElementById("reg-password").value;
    if (!email || !pass) return alert("Ingresa correo y contraseña");
    createUserWithEmailAndPassword(auth, email, pass)
      .then(cred => {
        userId = cred.user.uid;
        alert("Cuenta creada 🎉");
        crearMalla();
      })
      .catch(err => alert("Error: " + err.message));
  });

  document.getElementById("loginBtn").addEventListener("click", () => {
    const email = document.getElementById("login-email").value.trim();
    const pass = document.getElementById("login-password").value;
    if (!email || !pass) return alert("Ingresa correo y contraseña");
    mostrarCarga("Cargando tu malla...");
    signInWithEmailAndPassword(auth, email, pass)
      .then(cred => {
        userId = cred.user.uid;
        crearMalla();
        cargarEstado(userId).then(ocultarCarga);
      })
      .catch(err => {
        ocultarCarga();
        alert("Error al iniciar sesión: " + err.message);
      });
  });

  onAuthStateChanged(auth, user => {
    if (user) {
      userId = user.uid;
      crearMalla();
      cargarEstado(userId);
    }
  });

</script>
</body>
</html>